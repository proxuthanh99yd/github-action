name: Deploy repo to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Clone/Pull repo to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Verify secrets are set
        run: |
          echo "üîç Verifying secrets configuration..."
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "‚ùå ERROR: VPS_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_PORT }}" ]; then
            echo "‚ùå ERROR: VPS_PORT secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_USERNAME }}" ]; then
            echo "‚ùå ERROR: VPS_USERNAME secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_PASSWORD }}" ]; then
            echo "‚ùå ERROR: VPS_PASSWORD secret is not set"
            exit 1
          fi
          echo "‚úÖ All secrets are configured"
          echo "üìç Host: ${{ secrets.VPS_HOST }}"
          echo "üîå Port: ${{ secrets.VPS_PORT }}"
          echo "üë§ Username: ${{ secrets.VPS_USERNAME }}"

      - name: Test VPS connectivity
        run: |
          echo "üîç Testing connectivity to VPS..."
          echo "üìç Attempting to connect to ${{ secrets.VPS_HOST }}:${{ secrets.VPS_PORT }}"

          # Test if host is reachable (with timeout)
          if timeout 5 bash -c "cat < /dev/null > /dev/tcp/${{ secrets.VPS_HOST }}/${{ secrets.VPS_PORT }}" 2>/dev/null; then
            echo "‚úÖ Port ${{ secrets.VPS_PORT }} is open on ${{ secrets.VPS_HOST }}"
          else
            echo "‚ö†Ô∏è  WARNING: Cannot connect to ${{ secrets.VPS_HOST }}:${{ secrets.VPS_PORT }}"
            echo "üí° Troubleshooting tips:"
            echo "   1. Check if VPS has public IP or domain"
            echo "   2. Verify firewall allows SSH port (${{ secrets.VPS_PORT }})"
            echo "   3. Ensure VPS is running and SSH service is active"
            echo "   4. Try SSH manually: ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} -p ${{ secrets.VPS_PORT }}"
          fi

      - name: Deploy repo to VPS
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          port: ${{ secrets.VPS_PORT }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          timeout: 120s
          command_timeout: 60s
          debug: true
          use_insecure_cipher: false
          script: |
            echo "üîå Connected to VPS successfully"
            echo "üìç Current directory: $(pwd)"
            echo "üìç User: $(whoami)"

            REPO_URL="https://github.com/proxuthanh99yd/github-action.git"
            TARGET_DIR="/home/github-action"

            echo "üìÅ Creating /home directory if it doesn't exist..."
            mkdir -p /home
            echo "‚úÖ Directory /home ready"

            echo "üîç Checking if repository already exists..."
            if [ -d "$TARGET_DIR/.git" ]; then
              echo "üìÇ Repository exists, pulling latest changes..."
              cd $TARGET_DIR
              git pull origin main || git pull origin master
              echo "‚úÖ Repository updated successfully"
            else
              echo "üì• Repository not found, cloning..."
              cd /home
              git clone $REPO_URL github-action
              echo "‚úÖ Repository cloned successfully"
            fi

            echo "üîç Verifying repository..."
            if [ -d "$TARGET_DIR/.git" ]; then
              cd $TARGET_DIR
              COMMIT_HASH=$(git rev-parse --short HEAD)
              BRANCH=$(git branch --show-current)
              echo "‚úÖ SUCCESS: Repository $TARGET_DIR exists on VPS"
              echo "üìä Current branch: $BRANCH"
              echo "üìä Latest commit: $COMMIT_HASH"
              echo "üìã Repository contents:"
              ls -la $TARGET_DIR | head -20
            else
              echo "‚ùå ERROR: Repository not found after clone!"
              exit 1
            fi
