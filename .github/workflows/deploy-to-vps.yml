name: Deploy file to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Copy file to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Read file content
        id: read_file
        run: |
          echo "üìñ Reading example.txt content..."
          FILE_CONTENT_B64=$(base64 -w 0 example.txt)
          echo "file_content_b64=$FILE_CONTENT_B64" >> $GITHUB_OUTPUT
          echo "‚úÖ File content read and encoded"

      - name: Connecting to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          port: ${{ secrets.VPS_PORT }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          timeout: 60s
          command_timeout: 30s
          debug: true
          script: |
            echo "üîå Connected to VPS successfully"

      - name: Create directory if not exists
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          port: ${{ secrets.VPS_PORT }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          timeout: 60s
          command_timeout: 30s
          debug: true
          script: |
            echo "üìÅ Creating /home directory if it doesn't exist..."
            mkdir -p /home
            echo "‚úÖ Directory /home ready"

      - name: Copying example.txt to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          port: ${{ secrets.VPS_PORT }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          timeout: 60s
          command_timeout: 30s
          debug: true
          script: |
            echo "üìÑ Copying example.txt to /home/example.txt..."
            echo "${{ steps.read_file.outputs.file_content_b64 }}" | base64 -d > /home/example.txt
            echo "‚úÖ File copied successfully"

      - name: Verify file copied
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          port: ${{ secrets.VPS_PORT }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          timeout: 60s
          command_timeout: 30s
          debug: true
          script: |
            echo "üîç Verifying file exists..."
            if [ -f /home/example.txt ]; then
              echo "‚úÖ SUCCESS: File /home/example.txt exists on VPS"
              echo "üìä File size: $(stat -f%z /home/example.txt 2>/dev/null || stat -c%s /home/example.txt 2>/dev/null || echo 'unknown') bytes"
            else
              echo "‚ùå ERROR: File not found!"
              exit 1
            fi
